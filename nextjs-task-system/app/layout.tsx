import type { Metadata } from "next";
import { Inter } from "next/font/google";
import { ThemeModeScript } from "flowbite-react";
import "./globals.css";
import { SidebarComponent } from "@/components/layout/sideBar";
import { cookies } from "next/headers";
import { jwtVerify } from "jose";
import { verifyToken } from "@/actions/token/token-actions";
import { User } from "@/types/global-types";

const inter = Inter({ subsets: ["latin"] });

export const metadata: Metadata = {
  title: "Task system",
  description: "Generated by create flowbite react",
};

const secret = new TextEncoder().encode(process.env.JWT_SECRET);

export default async function RootLayout({
  children,
}: Readonly<{ children: React.ReactNode }>) {
  const cookieStore = cookies();
  const tokenExists = cookieStore.get("tokenLogin")?.value;

  if (!tokenExists) {
    return (
      <html lang="en">
        <head>
          <ThemeModeScript />
        </head>
        <body className={`${inter.className} min-h-screen bg-gray-50`}>
          {children}
        </body>
      </html>
    );
  }

  try {
    const { payload } = (await jwtVerify(tokenExists, secret)) as {
      payload: User;
    };

    verifyToken(payload);

    return (
      <html lang="en">
        <head>
          <ThemeModeScript />
        </head>
        <body className={`${inter.className} min-h-screen bg-gray-50`}>
          <SidebarComponent user={payload}>{children}</SidebarComponent>
        </body>
      </html>
    );
  } catch (error) {
    console.error("Token verification failed", error);

    return (
      <html lang="en">
        <head>
          <ThemeModeScript />
        </head>
        <body className={`${inter.className} min-h-screen bg-gray-50`}>
          {children}
        </body>
      </html>
    );
  }
}
